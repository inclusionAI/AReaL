resources:
  accelerators: H100:8
  image_id: docker:ghcr.io/inclusionai/areal-runtime:v0.3.3
  memory: 256+
  cpus: 32+

num_nodes: 2

workdir: .

volumes:
  # shared storage setup by SkyPilot Volume
  /storage: areal-shared-storage

setup: |
  pip3 install -e .

run: |
  # Get the Head node's IP and total number of nodes (environment variables injected by SkyPilot).
  head_ip=$(echo "$SKYPILOT_NODE_IPS" | head -n1)
  num_nodes=$(echo "$SKYPILOT_NODE_IPS" | wc -l)

  if [ "$SKYPILOT_NODE_RANK" = "0" ]; then
    echo "Starting Ray head node..."
    ray start --head --port=6379

    while [ $(ray nodes | grep NODE_ID | wc -l) -lt $num_nodes ]; do
      echo "Waiting for all nodes to join..."
      sleep 5
    done

    echo "Executing training script on head node..."
    python3 -m areal.launcher.ray examples/math/gsm8k_grpo.py \
            --config examples/skypilot/gsm8k_grpo_ray.yaml \
            experiment_name=<your experiment name> \
            trial_name=<your trial name> \
            trainer_env_vars="WANDB_API_KEY=$WANDB_API_KEY"
  else
    sleep 10
    echo "Starting Ray worker node..."
    ray start --address $head_ip:6379
    sleep 5
    fi

  echo "Node setup complete for rank $SKYPILOT_NODE_RANK."
